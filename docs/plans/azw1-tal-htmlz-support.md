# Plan: AZW1 (Topaz) / TAL / HTMLZ Support (The Anti-Christ)

## Status: BLOCKED — TAL positions do not index into HTMLZ

See **Investigation Findings** below before attempting implementation.

---

## Problem

*The Anti-Christ* is on the Kindle as an `.azw1` file (Amazon Topaz/TPZ format — a scanned-page
format, not MOBI or KF8). The annotation sidecar is a `.tal` file (KRDS format, 308 highlights,
90 notes). `krds.py` already decodes `.tal` correctly, and the positions are **plain integers**:

```
"startPosition": "14297",
"endPosition":   "14354"
```

The Calibre library has the book as `.htmlz` (a zip containing `book.html`, CSS, and images).

---

## Investigation Findings (February 2026)

### What was tried

The original plan assumed TAL positions were byte offsets into `book.html` inside the HTMLZ zip,
analogous to AZW3 byte offsets into KF8 Flow 0. An implementation was written on this basis and
tested. It produced garbage output — truncated mid-word fragments like `"The Ant"` instead of
complete sentences.

### Verification run

```python
import zipfile, json

htmlz = ".../The Anti-Christ - Friedrich Nietzsche.htmlz"
tal_json = ".../The Anti-Christ_B001C329DU...tal.json"

with zipfile.ZipFile(htmlz) as z:
    html = z.read("book.html")  # 213,961 bytes

# First highlight sorted by startPosition: start=263, end=276
# -> b'tml; charset='          # mid-tag debris
# start=292, end=299
# -> b'No Titl'                # cuts "No Title" mid-word
# start=14297, end=14354
# -> b'a foe of democracy in all its forms, political, religious'  # looks correct!
```

Some positions land on real text, many land mid-word or inside HTML tags. This is not a
boundary-snapping problem — the positions are simply not byte offsets into `book.html`.

### Root cause: Topaz internal format

Topaz (TPZ/AZW1) does **not** store text as raw bytes. The format structure is:

- `TPZ0` header followed by tagged binary records
- Text is stored tokenized through a **dictionary record** (`dict`/`dkey`)
- Page records reference token indices from the dictionary, not raw characters
- Glyph records contain vector rendering data for each character

Calibre's HTMLZ conversion assembles those dictionary tokens into HTML — but the byte layout
of the resulting `book.html` has **no relationship** to the token indices the Kindle uses
internally. TAL positions therefore cannot be byte offsets into `book.html`.

Calibre has **dropped Topaz conversion support** in recent versions (the `tpz_input` plugin
no longer exists in the frozen app bundle). The format is largely obsolete — Amazon stopped
selling Topaz books around 2012.

### What TAL positions likely are

TAL positions are most likely **character or token offsets into the Topaz internal text
stream** — the sequence of dictionary-token-resolved characters that the Kindle assembles
at render time. This is a proprietary internal representation with no publicly documented
mapping to any standard output format.

### Confirmed facts about the HTMLZ

- `book.html` is 213,961 bytes
- Contains `img/page0110_0000.svg` etc. — page images rendered from glyphs
- Contains OCR text assembled by Calibre from Topaz dictionary tokens
- The Calibre-generated `book.html` does **not** preserve Topaz token offsets

---

## What Would Be Required to Fix This

To map TAL positions to extractable text, one of the following approaches is needed:

### Option A: Parse the raw Topaz binary

1. Implement a TPZ parser that reads the `dict` record (variable-width integer encoded,
   compressed) and the `page` records.
2. Assemble the text in the same token order the Kindle firmware does.
3. Use TAL positions as offsets into that assembled string.

This requires reverse-engineering the Topaz binary format. The DeDRM tools'
historical Topaz scripts (from apprenticeharper's repository) are the best reference,
but this is significant work and the format is undocumented.

### Option B: Find a Calibre conversion that preserves offset mapping

Convert the `.azw1` to a format where the character byte positions match the TAL
offsets — e.g. a plain `.txt` file generated by an old Calibre version that had
Topaz input support. This would require an older Calibre install and verification
that the output positions match.

### Option C: Accept this book as unsupported

Topaz is a dead format. This is likely the only Topaz book in the library. Treat
AZW1 as unsupported; the annotations remain in `.sync_state.json` with
`status: metadata-only` for future reference.

---

## What Was Implemented and Reverted

A full implementation was written (commit `796399a`) and then reverted:

- `extract_highlights_htmlz.py` — new extractor (wrong approach, positions don't align)
- `extract_highlights.py` — format detection, process_pair branch, Calibre index changes

All code changes were reverted. The `_BOOK_FORMATS`, `find_annotation_for_stem()`,
and `build_calibre_index()` changes for AZW1/TAL/HTMLZ were removed.

---

## Original Plan (Superseded)

The original plan assumed the HTMLZ approach would work and is preserved below for
reference, but **should not be implemented without first solving the position mapping
problem**.

### Required Changes (original, now known-wrong)

1. New extractor `extract_highlights_htmlz.py` using byte offsets into `book.html`
2. `_BOOK_FORMATS` — add `.azw1: [".tal", ".tas"]`
3. `process_pair()` — HTMLZ branch invoking extractor via `sys.executable`
4. `find_annotation_for_stem()` — add `.tal`, `.tas` to `all_ann_exts`
5. `build_calibre_index()` — add `HTMLZ` to format query and priority map

Items 2 and 4 are still valid infrastructure changes (they don't hurt anything and
allow `.tal` files to be imported via `--import-metadata`). Items 1, 3, and 5
require the position mapping problem to be solved first.
